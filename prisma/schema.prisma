generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ─── ENUMS ───────────────────────────────────────────────────────────

enum UserRole {
  ADMIN
  CUSTOMER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum ScanType {
  MATTERPORT
  NIRA
}

enum FeatureKey {
  ANALYTICS
  INVENTORY
  SHARE_LINKS
  ANNOTATIONS
  EMBED_WIDGET
  SCHEDULED_REPORTS
}

enum AnnotationType {
  NOTE
  ISSUE
  COMMENT
}

enum AnnotationStatus {
  OPEN
  RESOLVED
}

enum ReportFrequency {
  WEEKLY
  MONTHLY
}

enum ScanEventType {
  MOVE
  ZOOM
  TAG_CLICK
  HOTSPOT_CLICK
  DWELL
}

enum HeatmapTimeRange {
  DAY
  WEEK
  MONTH
  ALL
}

enum AssetCategory {
  FURNITURE
  ELECTRONICS
  APPLIANCE
  FIXTURE
  ART
  JEWELRY
  CLOTHING
  OTHER
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum ExportType {
  INVENTORY_PDF
  INVENTORY_CSV
  ANALYTICS_PDF
  ANALYTICS_CSV
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ─── USER ────────────────────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  phoneVerified Boolean   @default(false)
  role          UserRole  @default(CUSTOMER)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?

  accounts          Account[]
  sessions          Session[]
  shareLinksCreated ShareLink[]  @relation("ShareLinksCreated")
  annotationsCreated Annotation[] @relation("AnnotationsCreated")

  @@index([email])
  @@index([organizationId])
  @@map("users")
}

// ─── ORGANIZATION (TENANT) ───────────────────────────────────────────

model Organization {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  contactName  String?
  contactEmail String?
  contactPhone String?
  notes        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users           User[]
  properties      Property[]
  invites         Invite[]
  features        OrganizationFeature[]
  exports         ExportJob[]
  reportSchedules ReportSchedule[]

  @@index([slug])
  @@map("organizations")
}

// ─── PROPERTY ────────────────────────────────────────────────────────

model Property {
  id             String   @id @default(cuid())
  name           String
  address        String?
  city           String?
  state          String?
  zipCode        String?
  description    String?
  thumbnailUrl   String?
  sortOrder      Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  scans           Scan[]
  assets          AssetItem[]
  exports         ExportJob[]
  shareLinks      ShareLink[]
  embedConfigs    EmbedConfig[]
  reportSchedules ReportSchedule[]

  @@index([organizationId])
  @@map("properties")
}

// ─── SCAN ────────────────────────────────────────────────────────────

model Scan {
  id          String   @id @default(cuid())
  name        String
  type        ScanType
  embedUrl      String
  matterportSid String?
  description   String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  sessions    ScanSession[]
  tags        ScanTag[]
  heatmaps    HeatmapSnapshot[]
  annotations Annotation[]

  @@index([propertyId])
  @@map("scans")
}

// ─── INVITE ──────────────────────────────────────────────────────────

model Invite {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  status         InviteStatus @default(PENDING)
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  @@index([token])
  @@index([email])
  @@map("invites")
}

// ─── PASSWORD RESET ──────────────────────────────────────────────────

model PasswordReset {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([email])
  @@map("password_resets")
}

// ─── PHONE VERIFICATION ─────────────────────────────────────────────

model PhoneVerification {
  id        String   @id @default(cuid())
  userId    String
  phone     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("phone_verifications")
}

// ─── ORGANIZATION FEATURE (FEATURE GATING) ──────────────────────────

model OrganizationFeature {
  id             String     @id @default(cuid())
  featureKey     FeatureKey
  enabledAt      DateTime   @default(now())
  enabledBy      String?

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  @@unique([organizationId, featureKey])
  @@index([organizationId])
  @@map("organization_features")
}

// ─── SCAN SESSION (ANALYTICS) ───────────────────────────────────────

model ScanSession {
  id         String    @id @default(cuid())
  visitorId  String
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  duration   Int?
  deviceType String?
  entryPoint String?
  totalMoves Int       @default(0)
  totalZooms Int       @default(0)

  scan   Scan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
  scanId String

  events ScanEvent[]

  @@index([scanId])
  @@index([startedAt])
  @@map("scan_sessions")
}

// ─── SCAN EVENT (ANALYTICS) ─────────────────────────────────────────

model ScanEvent {
  id        String        @id @default(cuid())
  type      ScanEventType
  timestamp DateTime      @default(now())
  positionX Float?
  positionY Float?
  positionZ Float?
  targetId  String?
  metadata  Json?
  duration  Float?

  session   ScanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String

  @@index([sessionId])
  @@index([type])
  @@map("scan_events")
}

// ─── SCAN TAG (ANALYTICS) ───────────────────────────────────────────

model ScanTag {
  id             String  @id @default(cuid())
  tagId          String
  label          String
  category       String?
  positionX      Float?
  positionY      Float?
  positionZ      Float?
  totalClicks    Int     @default(0)
  totalDwellTime Float   @default(0)
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  scan   Scan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
  scanId String

  @@unique([scanId, tagId])
  @@index([scanId])
  @@map("scan_tags")
}

// ─── HEATMAP SNAPSHOT (ANALYTICS) ───────────────────────────────────

model HeatmapSnapshot {
  id          String           @id @default(cuid())
  generatedAt DateTime         @default(now())
  timeRange   HeatmapTimeRange
  dataPoints  Json
  peakZones   Json?

  scan   Scan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
  scanId String

  @@index([scanId])
  @@index([timeRange])
  @@map("heatmap_snapshots")
}

// ─── ASSET ITEM (INVENTORY) ─────────────────────────────────────────

model AssetItem {
  id             String         @id @default(cuid())
  roomName       String
  category       AssetCategory
  name           String
  description    String?
  brand          String?
  model          String?
  serialNumber   String?
  purchaseDate   DateTime?
  purchasePrice  Float?
  estimatedValue Float?
  condition      AssetCondition @default(GOOD)
  notes          String?
  positionX      Float?
  positionY      Float?
  positionZ      Float?
  scanTagId      String?
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  photos AssetPhoto[]

  @@index([propertyId])
  @@index([roomName])
  @@index([category])
  @@map("asset_items")
}

// ─── ASSET PHOTO (INVENTORY) ────────────────────────────────────────

model AssetPhoto {
  id        String  @id @default(cuid())
  url       String
  caption   String?
  isPrimary Boolean @default(false)
  sortOrder Int     @default(0)
  createdAt DateTime @default(now())

  assetItem   AssetItem @relation(fields: [assetItemId], references: [id], onDelete: Cascade)
  assetItemId String

  @@index([assetItemId])
  @@map("asset_photos")
}

// ─── EXPORT JOB ─────────────────────────────────────────────────────

model ExportJob {
  id           String       @id @default(cuid())
  type         ExportType
  status       ExportStatus @default(PENDING)
  fileUrl      String?
  requestedBy  String
  requestedAt  DateTime     @default(now())
  completedAt  DateTime?
  metadata     Json?

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  propertyId String?

  @@index([organizationId])
  @@index([status])
  @@map("export_jobs")
}

// ─── SHARE LINK ─────────────────────────────────────────────────────

model ShareLink {
  id             String    @id @default(cuid())
  token          String    @unique
  passwordHash   String?
  expiresAt      DateTime
  maxViews       Int?
  accessCount    Int       @default(0)
  lastAccessedAt DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  createdBy   User   @relation("ShareLinksCreated", fields: [createdById], references: [id])
  createdById String

  @@index([token])
  @@index([propertyId])
  @@map("share_links")
}

// ─── ANNOTATION ─────────────────────────────────────────────────────

model Annotation {
  id        String           @id @default(cuid())
  content   String
  type      AnnotationType
  status    AnnotationStatus @default(OPEN)
  color     String           @default("#ef4444")
  positionX Float
  positionY Float
  positionZ Float
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  scan     Scan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
  scanId   String

  author   User   @relation("AnnotationsCreated", fields: [authorId], references: [id])
  authorId String

  @@index([scanId])
  @@index([authorId])
  @@index([type])
  @@index([status])
  @@map("annotations")
}

// ─── EMBED CONFIG ───────────────────────────────────────────────────

model EmbedConfig {
  id             String   @id @default(cuid())
  apiKey         String   @unique
  allowedDomains String[]
  brandingColor  String?
  showLogo       Boolean  @default(true)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  @@index([apiKey])
  @@index([propertyId])
  @@map("embed_configs")
}

// ─── REPORT SCHEDULE ────────────────────────────────────────────────

model ReportSchedule {
  id         String          @id @default(cuid())
  frequency  ReportFrequency
  recipients String[]
  lastSentAt DateTime?
  nextSendAt DateTime
  isActive   Boolean         @default(true)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  propertyId String?

  @@index([organizationId])
  @@index([nextSendAt])
  @@index([isActive])
  @@map("report_schedules")
}

// ─── AUTH.JS REQUIRED TABLES ─────────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
